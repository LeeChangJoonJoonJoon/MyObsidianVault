

2023-05-06

----
#Cpp #메모리 #CS #게임서버프로그래밍교과서 

## 개요
[[기기의 CPU 자원을 모두 사용하지 못할 때]]를 공부하던 도중, '게임서버프로그래밍교과서'의 저자는  두번째 예제가 작동되지 않는 이유를 분석하기에 앞서 '컨텍스트 스위치'를 설명한다.

## 내용
컴퓨터는 겉으로 보아 한번에 여러 일(스레드)을 수행하는 것처럼 보일 뿐, 실제로는 그렇게 작동하지 않는다.
다만, 여러 일(스레드)들을 왔다갔다 하면서 처리하기에 인간의 눈에는 그것이 동시에 처리되는 것처럼 보일 뿐이다.

이 '왔다갔다'를, CS 용어로 *'컨텍스트 스위치'(Context Switch)*라고 한다.

그려면 무조건 이것이 여러번 실행되는 것이 좋은가?
아니다.

이 컨텍스트 스위치는, 지금 진행되던 스레드를 어디까지 실행했는지를 기억시켜 놓은 채로, 다른 스레드로 진입하여 그 스레드가 이전에 어디까지 진행되고 있었는지 인식하여 그것을 실행시키는 과정을 말한다.
이는 스레드에게 할당된 프로세스만큼이나 많은 연산을 요하는 작업인 것이다.
따라서 컴퓨팅 자원을 효율적으로 쓰고자 한다면 컨텍스트 스위치가 적을 수록 좋다.
![[스크린샷 2023-05-06 오후 11.07.40.png|500]]

그렇다고 극단적으로 컨텍스트 스위치가 스레드 간 한번만 일어나게 되면 어떻게 될까?
그냥 하나하나씩 차례대로 처리하는 것과 다를 바 없게 된다.

결론적으로, 다음 빈도로 컨텍스트 스위치가 일어나는 것이 좋다.

*컴퓨팅 자원에 크게 영향을 미치지 않을 정도까지만 많이, 
사람 눈에 동시에 실행되고 있다고 느낄 정도까지만 적게*

### 컨텍스트 스위치의 발생은 CPU 개수와 스레드 개수에 따라 달라진다
만약 CPU 개수와 필요한 스레드 개수가 동일하다면 컨텍스트 스위치는 이론상 필요 없다.
하지만 필요한 스레드의 개수가 더 많으면, 어느 CPU에선 분명 컨텍스트 스위치가 발생한다.

그리고 이 컨텍스트 스위치에 의해 성능 문제가 생긴다.
근데 우리가 쓰는 수십 기가바이트 용량의 상용 프로그램들은 그런 문제가 잘 생기지 않는 것 같다. 
왜 그럴까?

그 이유는, Runnable (실행중인) 스레드의 개수를 CPU 개수에 맞추어서 소프트웨어를 설계하기 때문이다.
즉, 나머지 수십기가는 Waitable (잠자는) 스레드인 것이다.

### 어디까지 실행된 뒤에 컨텍스트 스위치가 발생하는가?
우리가 쓰는 언어들은 하나의 키워드가 수많은 기계어로 컴파일된다.
컴퓨터는 이 기계어 단위로 실행을 끊고 컨텍스트 스위치를 일으킨다.
즉, 우리가 쓴 명령어 한 줄 내에서 실행이 끊길 수도 있다는 것이다.